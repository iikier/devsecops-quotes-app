# ========================================
# PIPELINE DEVSECOPS - GITHUB ACTIONS
# ========================================
# Pipeline completo com seguranÃ§a integrada: SAST, Container Security, Dependency Scanning

name: ğŸ›¡ï¸ DevSecOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  AWS_REGION: 'us-east-1'
  ECR_REPOSITORY: 'devsecops-quotes-dev'

jobs:
  # ========================================
  # STAGE 1: SETUP & LINT
  # ========================================
  setup-and-lint:
    name: ğŸ” Setup & Code Quality
    runs-on: ubuntu-latest
    outputs:
      changed-files: ${{ steps.changes.outputs.any }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ§¹ ESLint Check
        run: |
          npm install eslint --save-dev
          npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0 || echo "ESLint warnings found"

      - name: ğŸ” Detect Changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            any:
              - '**/*.js'
              - '**/*.json'
              - '**/Dockerfile'
              - '**/*.tf'

  # ========================================
  # STAGE 2: SECURITY SCANS
  # ========================================
  security-scanning:
    name: ğŸ›¡ï¸ Security Scanning
    runs-on: ubuntu-latest
    needs: setup-and-lint
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # Dependency Vulnerability Scanning
      - name: ğŸ” Dependency Scan - npm audit
        run: |
          echo "ğŸ“¦ Running npm audit..."
          npm audit --audit-level=moderate --json > npm-audit.json || true
          
          # Se houver vulnerabilidades crÃ­ticas, falhar o pipeline
          CRITICAL=$(cat npm-audit.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(cat npm-audit.json | jq '.metadata.vulnerabilities.high // 0')
          
          echo "ğŸš¨ Critical vulnerabilities: $CRITICAL"
          echo "âš ï¸ High vulnerabilities: $HIGH"
          
          if [ "$CRITICAL" -gt 0 ]; then
            echo "âŒ Critical vulnerabilities found! Pipeline failed."
            exit 1
          fi

      # Infrastructure Scanning
      - name: ğŸ” IaC Scan - Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          framework: terraform
          output_format: sarif
          output_file_path: checkov.sarif
        continue-on-error: true

      - name: ğŸ“¤ Upload Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            npm-audit.json
            checkov.sarif

  # ========================================
  # STAGE 3: BUILD & TEST
  # ========================================
  build-and-test:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: [setup-and-lint, security-scanning]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ§ª Run Tests
        run: |
          echo "Running tests..."
          # npm test
          echo "âœ… Tests passed (placeholder)"

      - name: ğŸ³ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ³ Build and Push Docker Image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # Container Security Scanning
      - name: ğŸ” Container Scan - Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ” Container Scan - Grype
        uses: anchore/scan-action@v3
        with:
          image: '${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}'
          fail-build: false
          output-format: sarif
          output-file: grype-results.sarif

      - name: ğŸ“¤ Upload Container Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-results
          path: |
            trivy-results.sarif
            grype-results.sarif

  # ========================================
  # STAGE 4: DEPLOY TO DEV
  # ========================================
  deploy-dev:
    name: ğŸš€ Deploy to Development
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    environment: development
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ğŸŒ Get EC2 Public IP
        id: ec2-ip
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=devsecops-quotes-dev-instance" "Name=instance-state-name,Values=running" --query "Reservations[0].Instances[0].InstanceId" --output text)
          EC2_IP=$(aws ec2 describe-instances --instance-ids $INSTANCE_ID --query "Reservations[0].Instances[0].PublicIpAddress" --output text)
          echo "ip=$EC2_IP" >> $GITHUB_OUTPUT
        
      - name: ğŸš€ Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ steps.ec2-ip.outputs.ip }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Conectado ao servidor!"
            
            # Login no ECR a partir da instÃ¢ncia EC2 (usa o IAM Role)
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}
            
            # Pull da imagem mais recente
            docker pull ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
            
            # Parar e remover o contÃªiner antigo, se existir
            docker stop devsecops-app || true
            docker rm devsecops-app || true
            
            # Rodar o novo contÃªiner
            docker run -d --name devsecops-app -p 3000:3000 ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
            
            echo "ğŸš€ ImplantaÃ§Ã£o concluÃ­da com sucesso!"

  # ========================================
  # STAGE 5: MONITORING & NOTIFICATIONS
  # ========================================
  monitoring-setup:
    name: ğŸ“Š Setup Monitoring
    runs-on: ubuntu-latest
    needs: [deploy-dev]
    if: success()
    steps:
      - name: ğŸ“Š Configure CloudWatch Alarms
        run: |
          echo "ğŸ“Š Setting up monitoring and alerts..."
          
          # Criar alarm para CPU alta
          aws cloudwatch put-metric-alarm \
            --alarm-name "devsecops-quotes-dev-high-cpu" \
            --alarm-description "High CPU utilization" \
            --metric-name CPUUtilization \
            --namespace AWS/EC2 \
            --statistic Average \
            --period 300 \
            --threshold 80 \
            --comparison-operator GreaterThanThreshold \
            --evaluation-periods 2 \
            --alarm-actions arn:aws:sns:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:devsecops-alerts

      - name: ğŸ”” Notify Deployment Success
        uses: 8398a7/action-slack@v3
        with:
          status: success
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: 'ğŸš€ DevSecOps Pipeline completed successfully! Application deployed to development environment.'

  # ========================================
  # FAILURE NOTIFICATION
  # ========================================
  notify-failure:
    name: ğŸš¨ Notify Failure
    runs-on: ubuntu-latest
    needs: [setup-and-lint, security-scanning, build-and-test, deploy-dev]
    if: failure()
    steps:
      - name: ğŸš¨ Notify Pipeline Failure
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: 'âŒ DevSecOps Pipeline failed! Please check the logs and fix the issues.'

  # ========================================
  # STAGE 5: POST-DEPLOYMENT (Futuro)
  # ========================================
  post-deployment-tests:
    name: ğŸ’¨ Post-Deployment Checks
    runs-on: ubuntu-latest
    needs: deploy-dev
    steps:
      - name: ğŸŒ Run Health Check
        run: |
          echo "Verificando a saÃºde da aplicaÃ§Ã£o..."
          # curl -f http://<IP_DA_INSTANCIA>:3000/health
          echo "âœ… AplicaÃ§Ã£o estÃ¡ saudÃ¡vel!" 